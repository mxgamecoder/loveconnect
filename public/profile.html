<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile | LoveConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 280px;
      background: #fff;
      color: #333;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 12px 18px;
      z-index: 999;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: fadeIn 0.3s;
    }
    .popup-success { border-left: 5px solid #ec4899; }
    .popup-error { border-left: 5px solid #ef4444; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Verification Modal Styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .white-bg {
      background-color: #fff;
    }
  </style>
</head>
<body class="min-h-screen bg-pink-50 flex flex-col items-center pt-6">

  <div id="popup-container"></div>

  <div class="w-full max-w-lg px-4">
    <div class="flex items-center mb-5">
      <a href="settings.html" class="text-pink-600 hover:text-pink-800 mr-2">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
      </a>
      <h2 class="text-2xl font-bold text-pink-600">Profile</h2>
    </div>

    <form id="profileForm" class="space-y-5 bg-white rounded-lg shadow p-5">
      <div class="flex flex-col items-center mb-2">
        <div class="relative w-20 h-20">
          <img id="avatarPreview" class="w-20 h-20 rounded-full border-4 border-pink-500 object-cover" />
          <label for="avatarInput"
                 class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-40 rounded-full cursor-pointer text-white text-xl">
            📷
          </label>
          <input type="file" id="avatarInput" accept="image/*" class="hidden" />
        </div>
      </div>

      <!-- Breadcrumb navigation -->
      <div class="w-full flex justify-center mt-4 mb-6">
        <nav class="flex gap-4 text-pink-600 font-semibold" id="breadcrumbNav">
          <span class="cursor-pointer" data-section="profile">Profile</span>
          <span class="cursor-pointer" data-section="security">Security</span>
          <span class="cursor-pointer" data-section="contact">Contact</span>
        </nav>
      </div>

      <!-- Section containers -->
      <div id="sectionProfile" class="section-block">
        <!-- Username & Full Name -->
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Username</label>
          <input id="username" type="text" class="w-full border rounded px-3 py-2 mb-2" />
          <button id="changeUsernameBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change Username</button>
        </div>
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Full Name</label>
          <input id="fullName" type="text" class="w-full border rounded px-3 py-2 mb-2" />
          <button id="changeFullNameBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change Full Name</button>
        </div>
      </div>

      <div id="sectionSecurity" class="section-block hidden">
        <!-- Password & Email -->
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Password</label>
          <input id="password" type="password" class="w-full border rounded px-3 py-2 mb-2" placeholder="New Password" />
          <button id="changePasswordBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change Password</button>
        </div>
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Email</label>
          <input id="email" type="email" class="w-full border rounded px-3 py-2 mb-2" />
          <button id="changeEmailBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change Email</button>
        </div>
      </div>

      <div id="sectionContact" class="section-block hidden">
        <!-- Phone, Gender, DOB -->
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Phone Number</label>
          <input id="phoneNumber" type="text" class="w-full border rounded px-3 py-2 mb-2" />
          <button id="changePhoneBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change Phone</button>
        </div>
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Gender</label>
          <select id="gender" class="w-full border rounded px-3 py-2 mb-2">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
          <button id="changeGenderBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change Gender</button>
        </div>
        <div>
          <label class="block font-semibold text-pink-600 mb-1">Date of Birth</label>
          <input id="dob" type="date" class="w-full border rounded px-3 py-2 mb-2" />
          <button id="changeDobBtn" class="px-4 py-2 rounded bg-pink-500 text-white font-semibold mb-4">Change DOB</button>
        </div>
      </div>

      <div>
        <label class="block font-semibold text-pink-600 mb-1">Verification</label>
        <span id="isVerified" class="font-bold"></span>
        <div id="verifyBox" class="mt-2"></div>
      </div>
    </form>
  </div>

  <!-- Verification Modal Overlay -->
<div id="profileVerifyModal" class="overlay hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-sm text-center">
<h3 class="text-xl font-bold mb-4 text-pink-600" id="verifyModalTitle">Verify Action</h3>
      <p class="mb-4 text-gray-700" id="verifyModalMsg">Enter the code sent to your email or phone.</p>
      <input type="text" id="profileVerificationCode" maxlength="6" class="w-full px-4 py-2 border rounded-md mb-2" placeholder="Verification Code">
      <button id="profileVerifyBtn" class="w-full bg-pink-600 text-white py-2 rounded-md font-semibold hover:bg-pink-700 mb-2">Verify</button>
      <button id="profileCancelBtn" class="w-full bg-gray-200 text-pink-600 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
    </div>
  </div>

  <script>
    axios.defaults.baseURL = 'http://localhost:3000';

    function showPopup(message, type = 'success') {
      const popup = document.createElement('div');
      popup.className = `popup popup-${type}`;
      popup.innerHTML = type === 'success'
        ? `<svg width="18" height="18" fill="#ec4899"><circle cx="9" cy="9" r="9"/></svg>`
        : `<svg width="18" height="18" fill="#ef4444"><circle cx="9" cy="9" r="9"/></svg>`;
      popup.innerHTML += `<span>${message}</span>`;
      document.getElementById('popup-container').appendChild(popup);
      setTimeout(() => popup.remove(), 2500);
    }

    let user = null;
    let userId = null;
    let accounts = [];
    let idx = 0;
    let verifyAction = null;
    let verifyPayload = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // Theme
      const theme = JSON.parse(localStorage.getItem('theme')) || { bg: '#fdf2f8', accent: '#ec4899' };
      document.body.style.background = theme.bg;

      // Get userId from localStorage
      accounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
      idx = parseInt(localStorage.getItem('currentAccountIndex') || '0');
      user = accounts[idx];
      if (!user) return location.href = 'login.html';
      userId = user.userId;

      // Fetch latest user data from backend
      try {
        const res = await axios.get(`/api/profile/${userId}`);
        user = res.data;
        accounts[idx] = user;
        localStorage.setItem('userAccounts', JSON.stringify(accounts));
      } catch {
        showPopup('Failed to fetch profile.', 'error');
      }

      // After fetching user data from backend
      document.getElementById('username').value = user.username || '';
      document.getElementById('fullName').value = user.fullName || '';
      document.getElementById('email').value = user.email || '';
      document.getElementById('phoneNumber').value = user.phoneNumber || '';
      document.getElementById('gender').value = user.gender || 'Male';
      document.getElementById('dob').value = user.dob ? user.dob.split('T')[0] : '';

    });

    // Save profile changes (full name, avatar)
    async function saveProfile() {
      const fullName = document.getElementById('fullName').value;
      try {
        const res = await axios.post('/api/update-profile', { userId, fullName, avatar: user.avatar });
        accounts[idx] = { ...accounts[idx], ...res.data };
        localStorage.setItem('userAccounts', JSON.stringify(accounts));
        showPopup('Profile updated!', 'success');
      } catch (err) {
        showPopup(err.response?.data?.message || 'Update failed.', 'error');
      }
    }

// Change Email
async function changeEmail() {
  const newEmail = document.getElementById('email').value;
  if (newEmail === user.email) return showPopup('Email is the same as current.', 'error');
  try {
    await axios.post('/api/check-email', { email: newEmail });
  } catch {
    return showPopup('Email already in use.', 'error');
  }
  if (!/^[^\s@]+@(gmail\.com|yahoo\.com|outlook\.com)$/.test(newEmail)) {
    return showPopup('Email must be gmail.com, yahoo.com, or outlook.com.', 'error');
  }

  // Send code to current email
  await axios.post('/api/send-verification-code', { userId, email: user.email });

  showProfileVerifyModal(
    async function (code) {
      try {
        await axios.post('/api/update-email', { userId, code, newEmail });
        showPopup('Email changed!', 'success');
        document.getElementById('email').value = newEmail;
        document.getElementById('profileVerifyModal').classList.add('hidden'); // close modal
      } catch (err) {
        showPopup(err.response?.data?.message || err.message || 'Code invalid.', 'error');
      }
    },
    null,
    'Verify Email Change',
    'Enter the code sent to your current email.'
  );
}

// Change Phone
async function changePhone() {
  const newPhone = document.getElementById('phoneNumber').value;
  if (newPhone === user.phoneNumber) return showPopup('Phone is the same as current.', 'error');
  try {
    await axios.post('/api/check-phone', { phoneNumber: newPhone });
  } catch {
    return showPopup('Phone already in use.', 'error');
  }
  if (!/^\+\d{10,15}$/.test(newPhone)) {
    return showPopup('Phone must be in format +countrycode and numbers only.', 'error');
  }

  await axios.post('/api/send-verification-code', { userId, email: user.email });

  showProfileVerifyModal(
    async function (code) {
      try {
        await axios.post('/api/update-phone', { userId, code, newPhone });
        showPopup('Phone changed!', 'success');
        document.getElementById('phoneNumber').value = newPhone;
        document.getElementById('profileVerifyModal').classList.add('hidden');
      } catch (err) {
        showPopup(err.response?.data?.message || err.message || 'Code invalid.', 'error');
      }
    },
    null,
    'Verify Phone Change',
    'Enter the code sent to your email.'
  );
}

// Change Password
async function changePassword() {
  const newPass = document.getElementById('password').value;
  if (!newPass) return showPopup('Enter your new password.', 'error');

  await axios.post('/api/send-verification-code', { userId, email: user.email });

  showProfileVerifyModal(
    async function (code) {
      try {
        await axios.post('/api/change-password', { userId, code, newPassword: newPass });
        showPopup('Password changed!', 'success');
        document.getElementById('password').value = '';
        document.getElementById('profileVerifyModal').classList.add('hidden');
      } catch (err) {
        showPopup(err.response?.data?.message || err.message || 'Code invalid.', 'error');
      }
    },
    null,
    'Verify Password Change',
    'Enter the code sent to your email.'
  );
}

// Verify Account
function showVerifyPrompt() {
  axios.post('/api/send-verification-code', { userId, email: user.email })
    .then(() => {
      showProfileVerifyModal(
        async function (code) {
          try {
            await axios.post('/api/verify', { userId, code });
            showPopup('Account verified!', 'success');

            const isVerifiedEl = document.getElementById('isVerified');
            const verifyBoxEl = document.getElementById('verifyBox');

            if (isVerifiedEl) {
              isVerifiedEl.textContent = '✅ Verified';
              isVerifiedEl.className = 'text-green-600 font-bold';
            }
            if (verifyBoxEl) {
              verifyBoxEl.innerHTML = '';
            }

            document.getElementById('profileVerifyModal').classList.add('hidden');
          } catch (err) {
            showPopup(err.response?.data?.message || err.message || 'Code invalid.', 'error');
          }
        },
        null,
        'Verify Account',
        'Enter the code sent to your email.'
      );
    })
    .catch(err => {
      showPopup(err.response?.data?.message || err.message || 'Failed to send verification code.', 'error');
    });
}

    // Show the verification modal
    function showProfileVerifyModal(action, payload, title, msg) {
      verifyAction = action;
      verifyPayload = payload;
      document.getElementById('verifyModalTitle').textContent = title || 'Verify Action';
      document.getElementById('verifyModalMsg').textContent = msg || 'Enter the code sent to your email or phone.';
      document.getElementById('profileVerificationCode').value = '';
      document.getElementById('profileVerifyModal').classList.remove('hidden');
    }

    // Hide the modal
    document.getElementById('profileCancelBtn').onclick = function() {
      document.getElementById('profileVerifyModal').classList.add('hidden');
    };

    // Handle verify button
// Handle verify button
document.getElementById('profileVerifyBtn').onclick = async function () {
  const code = document.getElementById('profileVerificationCode').value.trim();
  if (!code) {
    showPopup('Enter the code.', 'error');
    return;
  }

  if (verifyAction && typeof verifyAction === 'function') {
    await verifyAction(code, verifyPayload);
    // ❌ don't auto-close here — each action closes modal only on success
  }
};
  </script>
  <script src="script/profile.js"></script>
</body>
</html>
